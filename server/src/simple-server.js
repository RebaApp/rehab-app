const express = require('express');
const cors = require('cors');
const dotenv = require('dotenv');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3001;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('uploads'));
app.use('/assets', express.static(path.join(__dirname, '../../assets')));

// Настройка multer для загрузки файлов
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadPath = path.join(__dirname, '../uploads');
    fs.mkdirSync(uploadPath, { recursive: true });
    cb(null, uploadPath);
  },
  filename: (req, file, cb) => {
    cb(null, `${file.fieldname}-${Date.now()}${path.extname(file.originalname)}`);
  },
});

const upload = multer({ storage });

// Моковые данные
const mockCenters = [
  {
    id: '1',
    name: 'Центр Здоровья',
    city: 'Москва',
    address: 'ул. Тверская, 1',
    phone: '+7 (495) 123-45-67',
    email: 'info@center1.ru',
    rating: 4.5,
    reviewsCount: 25,
    verified: true,
    photos: ['https://via.placeholder.com/300x200?text=Center+1'],
    services: ['Алкоголизм', 'Наркомания'],
    description: 'Профессиональная помощь в борьбе с зависимостями',
    price: 'от 45 000 Р',
    duration: '14 дней',
    coordinatesLat: 55.7558,
    coordinatesLon: 37.6176,
    workingHours: 'Пн-Вс: 9:00-21:00',
    capacity: 50,
    yearFounded: 2015,
    license: 'ЛО-77-01-123456',
    descriptionFull: 'Наш центр предлагает комплексные программы реабилитации, включающие детоксикацию, психотерапию, групповые занятия и поддержку после выписки. Мы используем современные методики и гарантируем конфиденциальность.',
    methods: ['12 шагов', 'Когнитивно-поведенческая терапия', 'Арт-терапия'],
    reviews: [
      {
        id: '1',
        userName: 'Анна К.',
        rating: 5,
        text: 'Отличный центр! Очень помогли в борьбе с зависимостью. Рекомендую всем!',
        date: '2024-01-15'
      },
      {
        id: '2',
        userName: 'Михаил С.',
        rating: 4,
        text: 'Хорошие специалисты, индивидуальный подход к каждому пациенту.',
        date: '2024-01-10'
      }
    ]
  },
  {
    id: '2',
    name: 'Новая Жизнь',
    city: 'Санкт-Петербург',
    address: 'пр. Невский, 100',
    phone: '+7 (812) 234-56-78',
    email: 'info@center2.ru',
    rating: 4.8,
    reviewsCount: 18,
    verified: true,
    photos: ['https://via.placeholder.com/300x200?text=Center+2'],
    services: ['Игромания', 'Пищевая зависимость'],
    description: 'Современные методы реабилитации',
    price: 'от 60 000 Р',
    duration: '21 день',
    coordinatesLat: 59.9311,
    coordinatesLon: 30.3609,
    workingHours: 'Пн-Вс: 8:00-22:00',
    capacity: 30,
    yearFounded: 2018,
    license: 'ЛО-78-01-789012',
    descriptionFull: 'Специализируемся на лечении игровой и пищевой зависимости. Используем инновационные методы терапии и обеспечиваем полную поддержку пациентам и их семьям.',
    methods: ['Когнитивно-поведенческая терапия', 'Семейная терапия', 'Медитация'],
    reviews: [
      {
        id: '3',
        userName: 'Елена В.',
        rating: 5,
        text: 'Помогли справиться с игровой зависимостью. Очень благодарна!',
        date: '2024-01-20'
      }
    ]
  },
  {
    id: '3',
    name: 'Путь к Свободе',
    city: 'Казань',
    address: 'ул. Баумана, 15',
    phone: '+7 (843) 345-67-89',
    email: 'info@center3.ru',
    rating: 4.3,
    reviewsCount: 12,
    verified: true,
    photos: ['https://via.placeholder.com/300x200?text=Center+3'],
    services: ['Алкоголизм', 'Табакокурение'],
    description: 'Помощь в избавлении от вредных привычек',
    price: 'от 35 000 Р',
    duration: '10 дней',
    coordinatesLat: 55.8304,
    coordinatesLon: 49.0661,
    workingHours: 'Пн-Пт: 9:00-18:00',
    capacity: 25,
    yearFounded: 2020,
    license: 'ЛО-16-01-345678',
    descriptionFull: 'Центр специализируется на лечении алкогольной и табачной зависимости. Работаем с пациентами всех возрастов.',
    methods: ['12 шагов', 'Мотивационное интервью', 'Групповая терапия'],
    reviews: [
      {
        id: '4',
        userName: 'Дмитрий Р.',
        rating: 4,
        text: 'Хорошие результаты, рекомендую.',
        date: '2024-01-05'
      }
    ]
  },
  {
    id: '4',
    name: 'Возрождение',
    city: 'Екатеринбург',
    address: 'ул. Ленина, 45',
    phone: '+7 (343) 456-78-90',
    email: 'info@center4.ru',
    rating: 4.7,
    reviewsCount: 20,
    verified: true,
    photos: ['https://via.placeholder.com/300x200?text=Center+4'],
    services: ['Наркомания', 'Алкоголизм'],
    description: 'Комплексная реабилитация зависимостей',
    coordinatesLat: 56.8431,
    coordinatesLon: 60.6454,
    workingHours: 'Пн-Вс: 24/7',
    capacity: 40,
    yearFounded: 2012,
    license: 'ЛО-66-01-901234',
    descriptionFull: 'Круглосуточный центр реабилитации. Обеспечиваем полный цикл лечения от детоксикации до социальной адаптации.',
    methods: ['12 шагов', 'Медикаментозная терапия', 'Трудовая терапия'],
    reviews: [
      {
        id: '5',
        userName: 'Светлана М.',
        rating: 5,
        text: 'Спасли жизнь моему сыну. Огромное спасибо!',
        date: '2024-01-18'
      }
    ]
  },
  {
    id: '5',
    name: 'Гармония',
    city: 'Новосибирск',
    address: 'пр. Красный, 25',
    phone: '+7 (383) 567-89-01',
    email: 'info@center5.ru',
    rating: 4.6,
    reviewsCount: 15,
    verified: true,
    photos: ['https://via.placeholder.com/300x200?text=Center+5'],
    services: ['Пищевая зависимость', 'Игромания'],
    description: 'Современный подход к лечению зависимостей',
    coordinatesLat: 55.0084,
    coordinatesLon: 82.9357,
    workingHours: 'Пн-Сб: 10:00-20:00',
    capacity: 35,
    yearFounded: 2019,
    license: 'ЛО-54-01-567890',
    descriptionFull: 'Специализируемся на лечении пищевых расстройств и игровой зависимости. Используем современные методы психотерапии.',
    methods: ['Когнитивно-поведенческая терапия', 'Диалектическая поведенческая терапия', 'Йога-терапия'],
    reviews: [
      {
        id: '6',
        userName: 'Ольга К.',
        rating: 4,
        text: 'Помогли справиться с перееданием. Спасибо!',
        date: '2024-01-12'
      }
    ]
  }
];

const mockArticles = [
  {
    id: '1',
    title: 'Как бросить курить: 5 эффективных методов',
    content: 'Курение - одна из самых распространенных зависимостей в мире. В этой статье мы рассмотрим 5 проверенных методов, которые помогут вам навсегда избавиться от этой вредной привычки. 1. Никотинзаместительная терапия - использование пластырей, жвачек или спреев. 2. Поведенческая терапия - изменение привычек и триггеров. 3. Медикаментозное лечение - препараты, снижающие тягу к никотину. 4. Альтернативные методы - иглоукалывание, гипноз. 5. Поддержка близких и групповая терапия. Помните: каждый метод работает по-разному для разных людей. Главное - найти свой путь к свободе от курения.',
    excerpt: 'Проверенные способы избавления от никотиновой зависимости',
    category: 'Здоровье',
    author: 'Иванов И.И.',
    image: 'http://localhost:3001/assets/images/articles/1.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '2',
    title: 'Алкоголизм: причины и последствия',
    content: 'Алкоголизм - серьезное заболевание, которое затрагивает не только самого человека, но и его окружение. Причины развития алкогольной зависимости могут быть различными: генетическая предрасположенность, психологические факторы, социальное окружение, стрессовые ситуации. Последствия алкоголизма включают в себя: разрушение здоровья (цирроз печени, сердечно-сосудистые заболевания), проблемы в семье и на работе, финансовые трудности, социальную изоляцию. Важно понимать, что алкоголизм - это не слабость характера, а болезнь, которая требует профессионального лечения.',
    excerpt: 'Понимание природы алкогольной зависимости и её влияния на жизнь',
    category: 'Психология',
    author: 'Петрова А.С.',
    image: 'http://localhost:3001/assets/images/articles/2.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '3',
    title: 'Игровая зависимость: как распознать и помочь',
    content: 'Игровая зависимость становится все более распространенной проблемой в современном мире. Признаки игровой зависимости: постоянные мысли об игре, увеличение времени, проводимого за игрой, ложь о количестве времени, потраченного на игру, раздражение при попытках ограничить игру, использование игр для снятия стресса. Если вы заметили эти признаки у себя или близких, важно обратиться за профессиональной помощью. Лечение игровой зависимости включает психотерапию, медикаментозное лечение и поддержку семьи.',
    excerpt: 'Современная проблема: признаки игромании и пути решения',
    category: 'Психология',
    author: 'Сидоров В.Г.',
    image: 'http://localhost:3001/assets/images/articles/3.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '4',
    title: 'Роль семьи в процессе реабилитации',
    content: 'Семья играет ключевую роль в процессе реабилитации человека с зависимостью. Поддержка близких может значительно ускорить выздоровление, в то время как неправильное поведение может усугубить ситуацию. Как правильно поддерживать близкого человека: 1. Не обвиняйте и не критикуйте. 2. Поощряйте положительные изменения. 3. Участвуйте в семейной терапии. 4. Установите четкие границы. 5. Заботьтесь о собственном психическом здоровье. Помните: выздоровление - это процесс, который требует времени, терпения и поддержки всей семьи.',
    excerpt: 'Как близкие могут помочь в борьбе с зависимостью',
    category: 'Семья',
    author: 'Козлова Е.Д.',
    image: 'http://localhost:3001/assets/images/articles/4.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '5',
    title: 'Спорт и реабилитация: путь к новому телу',
    content: 'Физическая активность является важной частью процесса реабилитации от различных видов зависимостей. Спорт помогает: улучшить физическое здоровье, повысить самооценку, снизить уровень стресса и тревожности, улучшить сон, развить дисциплину и самоконтроль. Рекомендуемые виды физической активности: плавание, бег, йога, командные виды спорта, велоспорт. Начинайте с малого - даже 15-20 минут физической активности в день могут принести пользу. Важно выбрать тот вид спорта, который вам нравится, чтобы занятия приносили удовольствие.',
    excerpt: 'Физическая активность как важная часть выздоровления',
    category: 'Здоровье',
    author: 'Морозов А.П.',
    image: 'http://localhost:3001/assets/images/articles/5.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '6',
    title: 'Наркомания: первые признаки и пути помощи',
    content: 'Наркомания - это тяжелое заболевание, которое разрушает не только физическое, но и психическое здоровье человека. Первые признаки наркомании включают: резкие изменения в поведении, частые перепады настроения, проблемы с памятью и концентрацией, физические изменения (расширенные или суженные зрачки, изменения веса), социальную изоляцию, финансовые проблемы. Важно понимать, что наркомания - это не моральная слабость, а болезнь, требующая профессионального лечения. Пути помощи включают: обращение в специализированные центры реабилитации, поддержку близких, психотерапию, медикаментозное лечение, участие в группах взаимопомощи. Чем раньше начать лечение, тем больше шансов на успешное выздоровление.',
    excerpt: 'Как распознать наркозависимость и где искать помощь',
    category: 'Наркомания',
    author: 'Кузнецова М.А.',
    image: 'http://localhost:3001/assets/images/articles/6.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '7',
    title: 'Реабилитация после наркозависимости: этапы и методы',
    content: 'Реабилитация после наркозависимости - это длительный процесс, который включает несколько этапов. Первый этап - детоксикация, очищение организма от наркотических веществ под медицинским наблюдением. Второй этап - стационарная реабилитация, где пациент проходит интенсивную психотерапию, групповые занятия, обучается навыкам жизни без наркотиков. Третий этап - амбулаторная реабилитация, постепенное возвращение к нормальной жизни с постоянной поддержкой специалистов. Четвертый этап - социальная адаптация, восстановление отношений с семьей и обществом. Методы реабилитации включают: когнитивно-поведенческую терапию, программу "12 шагов", семейную терапию, арт-терапию, спортивные занятия. Успех реабилитации зависит от мотивации пациента, поддержки близких и профессионализма специалистов.',
    excerpt: 'Пошаговый процесс восстановления после наркозависимости',
    category: 'Реабилитация',
    author: 'Волков Д.С.',
    image: 'http://localhost:3001/assets/images/articles/7.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '8',
    title: 'Семья и наркомания: как помочь близкому человеку',
    content: 'Когда в семье появляется наркозависимый, это затрагивает всех ее членов. Семья играет crucial роль в процессе выздоровления. Важно понимать, что нельзя заставить человека лечиться, но можно создать условия для принятия решения о лечении. Признаки того, что близкий употребляет наркотики: изменения в поведении, частые исчезновения, проблемы с деньгами, физические изменения. Как помочь: не обвинять и не стыдить, не финансировать зависимость, установить четкие границы, предложить профессиональную помощь, заботиться о собственном психическом здоровье. Семейная терапия помогает восстановить доверие и научиться жить с выздоравливающим человеком. Важно помнить: вы не можете контролировать чужую зависимость, но можете контролировать свою реакцию на нее.',
    excerpt: 'Практические советы для семей наркозависимых',
    category: 'Семья',
    author: 'Морозова Е.В.',
    image: 'http://localhost:3001/assets/images/articles/8.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '9',
    title: 'Профилактика наркомании среди подростков',
    content: 'Профилактика наркомании среди подростков - это комплекс мер, направленных на предотвращение употребления наркотических веществ. Подростковый возраст - период повышенного риска, когда молодые люди экспериментируют и ищут новые ощущения. Факторы риска включают: проблемы в семье, низкую самооценку, давление сверстников, доступность наркотиков, отсутствие интересов и целей. Эффективная профилактика включает: открытое общение в семье о рисках наркотиков, развитие критического мышления, формирование здоровых интересов и хобби, обучение навыкам отказа, создание поддерживающей среды в школе. Важно говорить с подростками честно и без запугивания, объяснять реальные последствия употребления наркотиков. Родители должны быть примером здорового образа жизни и поддерживать доверительные отношения с детьми.',
    excerpt: 'Как защитить детей от наркотической зависимости',
    category: 'Профилактика',
    author: 'Новиков А.П.',
    image: 'http://localhost:3001/assets/images/articles/9.jpg',
    createdAt: new Date().toISOString()
  },
  {
    id: '10',
    title: 'Духовная реабилитация: поиск смысла жизни',
    content: 'Духовная реабилитация играет важную роль в процессе выздоровления от зависимостей. Многие люди, страдающие от зависимостей, теряют смысл жизни и чувство цели. Духовная реабилитация помогает: найти внутренний покой и гармонию, развить чувство благодарности, научиться прощать себя и других, обрести надежду на будущее, развить сострадание к себе и окружающим. Методы духовной реабилитации включают: медитацию и молитву, работу с духовным наставником, участие в духовных группах, изучение духовной литературы, практику благодарности. Важно понимать, что духовность - это не обязательно религия, а поиск смысла и цели в жизни. Каждый человек может найти свой путь к духовному росту и исцелению.',
    excerpt: 'Восстановление душевного равновесия и поиск цели',
    category: 'Духовность',
    author: 'Смирнов И.В.',
    image: 'http://localhost:3001/assets/images/articles/10.jpg',
    createdAt: new Date().toISOString()
  }
];

// Маршруты API

// Health check
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

// Главная страница
app.get('/', (req, res) => {
  res.json({
    message: 'REBA API is running!',
    version: '1.0.0',
    endpoints: {
      health: '/health',
      centers: '/api/centers',
      articles: '/api/articles',
      auth: '/api/auth'
    }
  });
});

// Получить все центры
app.get('/api/centers', (req, res) => {
  res.json(mockCenters);
});

// Получить центр по ID
app.get('/api/centers/:id', (req, res) => {
  const center = mockCenters.find(c => c.id === req.params.id);
  if (!center) {
    return res.status(404).json({ message: 'Center not found' });
  }
  res.json(center);
});

// Получить все статьи
app.get('/api/articles', (req, res) => {
  res.json(mockArticles);
});

// Получить статью по ID
app.get('/api/articles/:id', (req, res) => {
  const article = mockArticles.find(a => a.id === req.params.id);
  if (!article) {
    return res.status(404).json({ message: 'Article not found' });
  }
  res.json(article);
});

// Регистрация пользователя
app.post('/api/auth/register', (req, res) => {
  const { email, password, name, userType } = req.body;
  
  if (!email || !password || !name) {
    return res.status(400).json({ message: 'Please enter all required fields' });
  }
  
  // Моковая регистрация
  const user = {
    id: Date.now().toString(),
    email,
    name,
    userType: userType || 'user',
    token: 'mock-jwt-token-' + Date.now()
  };
  
  res.status(201).json(user);
});

// Вход пользователя
app.post('/api/auth/login', (req, res) => {
  const { email, password } = req.body;
  
  if (!email || !password) {
    return res.status(400).json({ message: 'Please enter email and password' });
  }
  
  // Моковый вход
  const user = {
    id: '1',
    email,
    name: 'Test User',
    userType: 'user',
    token: 'mock-jwt-token-' + Date.now()
  };
  
  res.json(user);
});

// Загрузка файлов
app.post('/api/upload', upload.single('file'), (req, res) => {
  if (!req.file) {
    return res.status(400).json({ message: 'No file uploaded' });
  }
  
  res.json({
    message: 'File uploaded successfully',
    filename: req.file.filename,
    path: `/uploads/${req.file.filename}`
  });
});

// Обработка ошибок
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ message: 'Something went wrong!' });
});

// 404 для несуществующих маршрутов
app.use('*', (req, res) => {
  res.status(404).json({ message: 'Route not found' });
});

// Запуск сервера
app.listen(PORT, '0.0.0.0', () => {
  console.log(`🚀 Server running on port ${PORT}`);
  console.log(`📊 Health check: http://localhost:${PORT}/health`);
  console.log(`🌐 API base: http://localhost:${PORT}/api`);
});
